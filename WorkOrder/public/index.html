<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connection Form</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- PDF.js for PDF processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <!-- docx for Word document creation -->
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <style>
    :root{
      --bg1:#eef3ff;
      --bg2:#ffffff;
      --card:#ffffffcc;
      --ink:#0f172a;
      --muted:#5b6475;
      --accent:#0A66C2;
      --accent-2:#6aa9ff;
      --ring:#0a66c23d;
      --line:#e6eaf1;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", Helvetica, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1100px 700px at 20% -10%, #dfeaff 0%, #f6f9ff 45%, #ffffff 70%) no-repeat,
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:32px 20px;
    }

    .page{
      max-width:1050px;
      margin:0 auto;
    }

    .form-shell{
      background:var(--card);
      backdrop-filter:saturate(1.2) blur(8px);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: 0 10px 30px rgba(16,24,40,.08);
      overflow:hidden;
    }

    header.hero{
      padding:28px 28px 18px;
      background:
        linear-gradient(180deg, #ffffffcc, #ffffffaa),
        radial-gradient(1200px 600px at 80% -40%, #b8d8ff55, transparent 60%),
        radial-gradient(900px 500px at 0% 0%, #9fd3ff44, transparent 60%);
      border-bottom:1px solid var(--line);
    }
    .title{
      margin:0 0 6px;
      font-size:28px;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:14.5px;
    }

    form{
      padding:26px;
    }

    .section{
      border:1px solid var(--line);
      border-radius:14px;
      padding:18px;
      margin-bottom:16px;
      background:#fff;
    }
    .section h2{
      margin:0 0 14px;
      font-size:15px;
      font-weight:700;
      color:#0b2a52;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .section h2::before{
      content:"";
      width:8px;height:8px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 4px #0a66c21f;
    }

    .grid{
      display:grid;
      gap:14px;
    }
    /* responsive columns */
    .cols-2{grid-template-columns: repeat(2,minmax(0,1fr));}
    .cols-3{grid-template-columns: repeat(3,minmax(0,1fr));}
    .cols-4{grid-template-columns: repeat(4,minmax(0,1fr));}
    @media (max-width:980px){ .cols-4{grid-template-columns: repeat(3,minmax(0,1fr));} }
    @media (max-width:780px){
      .cols-4,.cols-3{grid-template-columns: repeat(2,minmax(0,1fr));}
    }
    @media (max-width:520px){
      .cols-4,.cols-3,.cols-2{grid-template-columns: 1fr;}
    }

    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    label{
      font-size:12.5px;
      color:#334155;
      font-weight:600;
      letter-spacing:.15px;
    }
    input[type="text"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    input[type="email"],
    textarea,
    select{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      font-size:14.5px;
      outline:none;
      transition:.15s border, .15s box-shadow;
    }
    textarea{min-height:92px; resize:vertical;}
    input:focus, textarea:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 4px var(--ring);
    }

    .inline{
      display:flex; gap:14px; flex-wrap:wrap; align-items:center;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--line); border-radius:999px; background:#fff;
      font-size:13.5px;
    }
    .chip input{transform:translateY(1px)}
    .muted{ color:var(--muted); font-size:12.5px;}

    .submit-btn{
      background:linear-gradient(180deg, var(--accent), #08498f);
      color:#fff; border:none; border-radius:12px;
      padding:14px 18px; font-size:16px; font-weight:700; letter-spacing:.2px;
      cursor:pointer; width:100%; margin-top:6px;
      box-shadow:0 8px 18px rgba(10,102,194,.22);
    }
    .submit-btn:hover{filter:brightness(1.05)}
    .submit-btn:disabled{background:#9dbbe2; box-shadow:none; cursor:not-allowed}

    .thank-you{
      display:none; text-align:center; padding:34px 26px;
    }
    .thank-you h2{ color:var(--ok); margin:0 0 10px; }
    .download-btn{
      background:#22c55e; color:#fff; border:none; border-radius:12px; padding:12px 20px;
      font-size:15px; cursor:pointer; margin-top:10px;
      box-shadow:0 8px 18px rgba(34,197,94,.22);
    }
    .download-btn:hover{filter:brightness(1.05)}
    .download-btn:disabled{background:#a7d9b8; box-shadow:none; cursor:not-allowed}

    /* PDF Preview Styles */
    .pdf-previews {
      margin: 20px 0;
      text-align: left;
    }

    .pdf-previews h3 {
      color: var(--ink);
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 700;
    }

    .pdf-preview-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .pdf-preview-container {
        grid-template-columns: 1fr;
      }
    }

    .pdf-preview {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(16,24,40,.08);
    }

    .pdf-preview h4 {
      margin: 0 0 12px 0;
      color: var(--ink);
      font-size: 16px;
      font-weight: 600;
    }

    .download-pdf-btn {
      background: linear-gradient(180deg, #22c55e, #16a34a);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(34,197,94,.22);
      transition: all 0.15s ease;
    }

    .download-pdf-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .download-pdf-btn:active {
      transform: translateY(0);
    }

    .download-word-btn {
      background: linear-gradient(180deg, #2563eb, #1d4ed8);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.22);
      transition: all 0.15s ease;
    }

    /* Special styling for both main action buttons to be the same size */
    #downloadBtn, #downloadAllWordBtn {
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.2px;
      cursor: pointer;
      width: 100%;
      max-width: 300px;
      transition: all 0.15s ease;
    }

    #downloadBtn {
      background: linear-gradient(180deg, #22c55e, #16a34a);
      color: #fff;
      border: none;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.22);
    }

    #downloadAllWordBtn {
      background: linear-gradient(180deg, #2563eb, #1d4ed8);
      color: #fff;
      border: none;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.22);
    }

    #downloadBtn:hover, #downloadAllWordBtn:hover {
      filter: brightness(1.05);
    }

    #downloadBtn:disabled, #downloadAllWordBtn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .download-word-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .download-word-btn:active {
      transform: translateY(0);
    }

    .download-word-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      margin-top: 20px;
    }

    .back-button-container {
      display: flex;
      justify-content: center;
      margin-top: 16px;
    }

    .back-btn {
      background: linear-gradient(180deg, #6b7280, #4b5563);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(107,114,128,.22);
      transition: all 0.15s ease;
    }

    .back-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .back-btn:active {
      transform: translateY(0);
    }

    /* Drag and Drop Styles */
    .drag-drop-container {
      margin-top: 24px;
      display: flex;
      justify-content: center;
    }

    .drag-drop-area {
      width: 100%;
      max-width: 500px;
      min-height: 200px;
      border: 2px dashed var(--line);
      border-radius: 16px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .drag-drop-area::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(10,102,194,0.05), rgba(106,169,255,0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .drag-drop-area:hover {
      border-color: var(--accent);
      background: linear-gradient(135deg, #f0f7ff, #e6f2ff);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(10,102,194,0.15);
    }

    .drag-drop-area:hover::before {
      opacity: 1;
    }

    .drag-drop-area.drag-over {
      border-color: var(--accent);
      background: linear-gradient(135deg, #e6f2ff, #d1e7ff);
      transform: scale(1.02);
      box-shadow: 0 12px 30px rgba(10,102,194,0.25);
    }

    .drag-drop-area.drag-over::before {
      opacity: 1;
    }

    .drag-drop-content {
      text-align: center;
      z-index: 1;
      position: relative;
    }

    .drag-drop-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
      transition: all 0.3s ease;
    }

    .drag-drop-area:hover .drag-drop-icon {
      opacity: 1;
      transform: scale(1.1);
    }

    .drag-drop-content h3 {
      margin: 0 0 8px 0;
      color: var(--ink);
      font-size: 20px;
      font-weight: 700;
    }

    .drag-drop-content p {
      margin: 0 0 16px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .drag-drop-formats {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .format-badge {
      background: var(--accent);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* Field Menu Styles */
    .field-menu {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(16,24,40,.15);
      backdrop-filter: saturate(1.2) blur(12px);
      padding: 20px;
      max-width: 500px;
      max-height: 70vh;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .field-menu.show {
      display: block;
      animation: fadeInScale 0.2s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .field-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--line);
    }

    .field-menu-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--ink);
      margin: 0;
    }

    .field-menu-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background-color 0.15s;
    }

    .field-menu-close:hover {
      background: var(--line);
    }

    .field-list {
      display: grid;
      gap: 8px;
    }

    .field-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .field-item:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--ring);
    }

    .field-item.copied {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: #16a34a;
      color: white;
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .field-item.copied .field-id {
      color: white;
    }

    .field-item.copied .field-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .field-item.copied .field-type {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .field-item.copied .copy-tooltip {
      background: rgba(255, 255, 255, 0.9);
      color: var(--ink);
    }

    .field-item.copied .copy-tooltip::after {
      border-top-color: rgba(255, 255, 255, 0.9);
    }

    /* Subtle pulse animation for the copied state */
    @keyframes copiedPulse {
      0% { transform: scale(1.02); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1.02); }
    }

    .field-item.copied {
      animation: copiedPulse 0.6s ease-in-out;
    }

    .field-id {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: var(--accent);
      font-weight: 600;
    }

    .field-label {
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
    }

    .field-type {
      font-size: 11px;
      color: var(--muted);
      background: var(--line);
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field-id {
      cursor: pointer;
      position: relative;
    }

    .field-id:hover {
      color: var(--accent-2);
    }

    .copy-tooltip {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1001;
    }

    .copy-tooltip.show {
      opacity: 1;
    }

    .copy-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-top-color: var(--accent);
    }

    .field-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      display: none;
    }

    .field-menu-overlay.show {
      display: block;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .field-menu-search {
      margin-bottom: 16px;
    }

    .field-menu-search input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .field-menu-search input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--ring);
    }

    .field-menu-search input::placeholder {
      color: var(--muted);
    }

    .example-fill-btn {
      background: linear-gradient(180deg, #22c55e, #16a34a);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.2px;
      cursor: pointer;
      margin-top: 12px;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.22);
      transition: all 0.15s ease;
    }

    .example-fill-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.3);
    }

    .example-fill-btn:active {
      transform: translateY(0);
    }

    /* Mode badge and visibility helpers */
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
      letter-spacing:.2px; margin-left:8px; vertical-align:middle;
      background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;
    }
    .badge.disconnection{ background:#fee2e2; color:#991b1b; border-color:#fecaca }
    .hidden{ display:none !important }
    
    /* Visual cue styling for disconnection forms */
    .required-field-cue {
      border: 2px solid #3b82f6 !important;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1) !important;
      background: linear-gradient(135deg, #f8faff, #ffffff) !important;
      animation: pulse-blue 2s infinite;
    }
    
    @keyframes pulse-blue {
      0% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
      50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.2); }
      100% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="form-shell">
      <header class="hero">
        <h1 class="title">Connection Form</h1><center>
        <p class="subtitle">Enter the customer and service details below. When you submit, you'll be able to download a nicely formatted PDF.</p>
        <button type="button" id="exampleFillBtn" class="example-fill-btn" onclick="fillExampleData()" style="display: none;">Example Fill</button>
        <button type="button" id="uploadExcelBtn" class="example-fill-btn" style="margin-left:8px" >Upload Excel</button>
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" />
        
        <!-- Drag and Drop Area -->
        <div class="drag-drop-container">
          <div class="drag-drop-area" id="dragDropArea">
            <div class="drag-drop-content">
              <div class="drag-drop-icon">üìÅ</div>
              <h3>Drag & Drop Excel File</h3>
              <p>Or click to browse and select your Excel file</p>
              <div class="drag-drop-formats">
                <span class="format-badge">.xlsx</span>
                <span class="format-badge">.xls</span>
              </div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 12px; display: none;" id="formTypeContainer">
          <span id="formTypeBadge" class="badge">Form Type: Connection</span>
        </div>
      </header>

      <!-- Keep the same IDs and JS behavior -->
      <form id="customForm" onsubmit="return handleSubmit(event);" style="display: none;">

     
        <!-- Top line -->
        <div class="section">
          <h2>Header</h2>
          <div class="grid cols-4">
            <div class="field"><label for="date_called">Date Called</label><input type="date" id="date_called" name="date_called"></div>
            <div class="field"><label for="date_wanted">Date Wanted</label><input type="date" id="date_wanted" name="date_wanted"></div>
            <div class="field"><label for="account_number">Account #</label><input type="text" id="account_number" name="account_number" placeholder="e.g., 123456"></div>
            <div class="field"><label for="wo_number">W/O #</label><input type="text" id="wo_number" name="wo_number" placeholder="Work order"></div>
          </div>
           <div class="grid cols-2" style="margin-top: 10px;">
             <div class="field"><label for="cycle_number">Cycle #</label><input type="text" id="cycle_number" name="cycle_number" placeholder="e.g., 3"></div>
             <div class="field"><label for="clerks_name">Clerk's Name</label><input type="text" id="clerks_name" name="clerks_name" value="Cynthia"></div>
           </div>
        </div>

        <!-- Contract Relationship -->
        <div class="section" data-for="connection">
          <h2>Contract Relationship</h2>
          <div class="inline">
            <span class="muted">Relationship to Property:</span>
            <label class="chip"><input type="checkbox" id="owner" name="owner" value="yes"> Owner</label>
            <label class="chip"><input type="checkbox" id="tenant" name="tenant" value="yes"> Tenant</label>
            <label class="chip"><input type="checkbox" id="real_estate_agent" name="real_estate_agent" value="yes"> Real Estate Agent</label>
            <label class="chip"><input type="checkbox" id="property_manager" name="property_manager" value="yes"> Property Manager</label>
          </div>
        </div>

        <!-- Service Address & Type -->
        <div class="section">
          <h2>Service Address & Type</h2>
           <div class="grid cols-4">
             <div class="field"><label for="service_street">Street</label><input type="text" id="service_street" name="service_street" placeholder="Street address" onchange="updateFullServiceAddress()"></div>
             <div class="field"><label for="service_city">City</label><input type="text" id="service_city" name="service_city" value="SALINAS" onchange="updateFullServiceAddress()"></div>
             <div class="field"><label for="service_state">State</label><input type="text" id="service_state" name="service_state" value="CA" onchange="updateFullServiceAddress()"></div>
             <div class="field"><label for="service_zip">ZIP</label><input type="text" id="service_zip" name="service_zip" placeholder="ZIP code" onchange="updateFullServiceAddress()"></div>
           </div>
           <div class="grid cols-1" style="margin-top: 6px;">
             <div class="field"><label for="service_unit">Unit #</label><input type="text" id="service_unit" name="service_unit" placeholder="Unit number" onchange="updateFullServiceAddress()"></div>
           </div>
        </div>


        <!-- Customer -->
        <div class="section">
          <h2>Customer</h2>
          <div class="grid cols-3">
            <div class="field"><label for="first_name">First Name</label><input type="text" id="first_name" name="first_name" onchange="updateFullName()"></div>
            <div class="field" data-for="connection"><label for="middle_ex">MI / Ex</label><input type="text" id="middle_ex" name="middle_ex" placeholder="Optional"></div>
            <div class="field"><label for="last_name">Last Name</label><input type="text" id="last_name" name="last_name" onchange="updateFullName()"></div>
          </div>
          <div class="grid cols-1" style="margin-top:6px">
            <div class="field" data-for="connection"><label for="connect_date">Connect Date</label><input type="date" id="connect_date" name="connect_date"></div>
          </div>


          <div class="grid cols-2" style="margin-top:10px">
            <div class="field"><label for="contact_phone">Contact #</label><input type="tel" id="contact_phone" name="contact_phone" placeholder="(xxx) xxx-xxxx"></div>
          </div>
          
          <!-- Send Bill Address -->
          <div class="grid cols-4" style="margin-top:10px">
            <div class="field"><label for="send_bill_street">Send Bill - Street</label><input type="text" id="send_bill_street" name="send_bill_street" placeholder="Street address" onchange="updateFullBillAddress()"></div>
            <div class="field"><label for="send_bill_city">Send Bill - City</label><input type="text" id="send_bill_city" name="send_bill_city" value="Salinas" placeholder="City" onchange="updateFullBillAddress()"></div>
            <div class="field"><label for="send_bill_state">Send Bill - State</label><input type="text" id="send_bill_state" name="send_bill_state" value="CA" placeholder="State" onchange="updateFullBillAddress()"></div>
            <div class="field"><label for="send_bill_zip">Send Bill - ZIP</label><input type="text" id="send_bill_zip" name="send_bill_zip" placeholder="ZIP code" onchange="updateFullBillAddress()"></div>
          </div>
        </div>

        <!-- Employment & Identification - Main Applicant -->
        <div class="section" data-for="connection">
          <h2>Employment & Identification</h2>
           <div class="grid cols-2">
             <div class="field"><label for="employer_main">Employer</label><input type="text" id="employer_main" name="employer_main"></div>
             <div class="field"><label for="emp_phone_main">Emp. Phone</label><input type="tel" id="emp_phone_main" name="emp_phone_main" placeholder="(xxx) xxx-xxxx"></div>
           </div>
          <div class="grid cols-3" style="margin-top: 10px;">
             <div class="field"><label for="ssn_main">Social Security No</label><input type="text" id="ssn_main" name="ssn_main" maxlength="4" inputmode="numeric" pattern="[0-9]{4}" placeholder="XXXX"></div>
            <div class="field"><label for="id_no_main">I.D No</label><input type="text" id="id_no_main" name="id_no_main"></div>
            <div class="field"><label for="id_state_type">State/Type</label><input type="text" id="id_state_type" name="id_state_type"></div>
          </div>
          <div class="grid cols-2" style="margin-top: 10px;">
            <div class="field"><label for="id_exp_date_main">Exp Date</label><input type="date" id="id_exp_date_main" name="id_exp_date_main"></div>
          </div>
        </div>

        <!-- Employment & Identification - Spouse -->
        <div class="section" data-for="connection">
          <h2>Employment & Identification - Spouse</h2>
          <div class="grid cols-1" style="margin-bottom: 10px;">
            <div class="field"><label for="spouse_name">Spouse Name</label><input type="text" id="spouse_name" name="spouse_name" placeholder="Full name"></div>
          </div>
          <div class="grid cols-3">
            <div class="field"><label for="spouse_employer">Spouse Employer</label><input type="text" id="spouse_employer" name="spouse_employer"></div>
            <div class="field"><label for="spouse_emp_phone">Emp. Phone</label><input type="tel" id="spouse_emp_phone" name="spouse_emp_phone" placeholder="(xxx) xxx-xxxx"></div>
            <div class="field"><label for="spouse_ssn">Social Security No</label><input type="text" id="spouse_ssn" name="spouse_ssn" placeholder="XXX-XX-XXXX"></div>
          </div>
          <div class="grid cols-2" style="margin-top: 10px;">
            <div class="field"><label for="spouse_id_no">I.D No</label><input type="text" id="spouse_id_no" name="spouse_id_no"></div>
            <div class="field"><label for="spouse_id_exp_date">Exp Date</label><input type="date" id="spouse_id_exp_date" name="spouse_id_exp_date"></div>
          </div>
        </div>

        <!-- Previous Address -->
        <div class="section" data-for="connection">
          <h2>Previous Address</h2>
          <div class="grid">
            <div class="field">
              <label for="previous_address">Domicilio Anterior</label>
              <textarea id="previous_address" name="previous_address" placeholder="Street, City, State, ZIP"></textarea>
            </div>
          </div>
        </div>

        <!-- Deposit / Payment -->
        <div class="section" data-for="connection">
          <h2>Deposit & Payment</h2>
          <div class="grid cols-2">
            <div class="field"><label for="deposit_amount">Deposit</label><input type="number" id="deposit_amount" name="deposit_amount" step="0.01" value="150"></div>
            <div class="field"><label for="check_number">Check #</label><input type="text" id="check_number" name="check_number" placeholder="If paid by check"></div>
          </div>
          <div class="inline" style="margin-top: 10px;">
            <span class="muted">Deposit Type:</span>
            <label class="chip"><input type="checkbox" id="deposit_type_establish" name="deposit_type_establish" value="yes"> Re-establish Credit deposit</label>
            <label class="chip"><input type="checkbox" id="deposit_type_initial" name="deposit_type_initial" value="yes"> Initial Deposit</label>
          </div>
          <div class="inline" style="margin-top: 10px;">
            <span class="muted">Payment Method:</span>
            <label class="chip"><input type="checkbox" id="payment_method_cash" name="payment_method_cash" value="yes"> Cash</label>
            <label class="chip"><input type="checkbox" id="payment_method_check" name="payment_method_check" value="yes"> Check</label>
          </div>
        </div>

        <!-- Work Order & Reads -->
        <div class="section" data-for="connection">
          <h2>Work Order & Reads</h2>
           <div class="inline">
             <label class="chip"><input type="radio" id="install_new_service" name="service_option" value="install_new_service"> INSTALL NEW SERVICE</label>
             <label class="chip"><input type="radio" id="install_meter" name="service_option" value="install_meter"> INSTALL METER</label>
             <label class="chip"><input type="radio" id="read_and_turn_on" name="service_option" value="read_and_turn_on" checked> READ AND TURN ON</label>
           </div>
          <div class="grid cols-3" style="margin-top:10px">
            <div class="field"><label for="notes">Notes (optional)</label><input type="text" id="notes" name="notes" placeholder="Any additional details"></div>
            <div class="field"><label for="remarks">Remarks</label><input type="text" id="remarks" name="remarks" placeholder="Additional remarks"></div>
          </div>
           <div class="grid cols-1" style="margin-top:10px">
             <div class="field"><label for="comments">Comments</label><input type="text" id="comments" name="comments" value="VER ID"></div>
           </div>
        </div>

        <!-- Disconnect Options (Disconnection only) -->
        <div class="section" data-for="disconnection">
          <h2>Disconnect Options</h2>
          <div class="inline">
            <label class="chip"><input type="checkbox" id="shut_off_non_payment" name="shut_off_non_payment" value="yes"> SHUT OFF NON-PAYMENT</label>
            <label class="chip"><input type="checkbox" id="read_and_shut_off" name="read_and_shut_off" value="yes"> READ AND SHUT OFF</label>
            <label class="chip"><input type="checkbox" id="read_and_leave_on" name="read_and_leave_on" value="yes"> READ AND LEAVE ON</label>
          </div>
          
          <div class="inline" style="margin-top: 16px;">
            <span class="muted">Deposit Required?</span>
            <label class="chip"><input type="radio" id="deposit_required_yes" name="deposit_required" value="yes"> Yes</label>
            <label class="chip"><input type="radio" id="deposit_required_no" name="deposit_required" value="no"> No</label>
          </div>
          
          <div class="grid cols-3" style="margin-top: 16px;">
            <div class="field"><label for="disconnect_deposit_amount">Deposit Amount</label><input type="number" id="disconnect_deposit_amount" name="disconnect_deposit_amount" step="0.01" placeholder="0.00"></div>
            <div class="field"><label for="payment_due">Payment Due</label><input type="number" id="payment_due" name="payment_due" step="0.01" placeholder="0.00"></div>
            <div class="field"><label for="new_account_deposit">New account deposit</label><input type="number" id="new_account_deposit" name="new_account_deposit" step="0.01" placeholder="0.00"></div>
          </div>
          
          <div class="grid cols-1" style="margin-top: 16px;">
            <div class="field"><label for="disconnect_comments">Comments</label><input type="text" id="disconnect_comments" name="disconnect_comments" placeholder="Additional comments for disconnection"></div>
          </div>
        </div>


        <!-- Submit -->
        <button type="submit" class="submit-btn">Submit</button>
      </form>

      <!-- Thank you state with PDF previews -->
      <div id="thankYouMessage" class="thank-you">
       
        <!-- PDF Previews Section -->
        <div class="pdf-previews">
         
          <div class="pdf-preview-container">
            <div class="pdf-preview">
              <h4 id="pdf1Title">PDF 1</h4>
              <iframe id="pdf1Preview" src="" width="100%" height="400px" style="border: 1px solid var(--line); border-radius: 8px;"></iframe>
              <button class="download-pdf-btn" onclick="downloadPDF1()">Download PDF 1</button>
              <button class="download-word-btn" onclick="downloadWord1()">Download Word DOCX</button>
            </div>
            <div class="pdf-preview">
              <h4 id="pdf2Title">PDF 2</h4>
              <iframe id="pdf2Preview" src="" width="100%" height="400px" style="border: 1px solid var(--line); border-radius: 8px;"></iframe>
              <button class="download-pdf-btn" onclick="downloadPDF2()">Download PDF 2</button>
              <button class="download-word-btn" onclick="downloadWord2()">Download Word DOCX</button>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button id="downloadBtn" class="download-btn" onclick="downloadAllPDFs()">Download All PDFs</button>
          <button id="downloadAllWordBtn" class="download-word-btn" onclick="downloadAllWordDocs()">Download All Word DOCX</button>
        </div>
        <div class="back-button-container">
          <button id="backBtn" class="back-btn" onclick="goBackToForm()">Back to Form</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Field Menu Overlay and Modal -->
  <div id="fieldMenuOverlay" class="field-menu-overlay"></div>
  <div id="fieldMenu" class="field-menu">
    <div class="field-menu-header">
      <h3 class="field-menu-title">Form Fields</h3>
      <button class="field-menu-close" onclick="closeFieldMenu()">&times;</button>
    </div>
    <div class="field-menu-search">
      <input type="text" id="fieldSearch" placeholder="Search fields..." autocomplete="off">
    </div>
    <div id="fieldList" class="field-list">
      <!-- Field items will be populated by JavaScript -->
    </div>
  </div>

  <script>
    // Auto-fill today's date when page loads
    document.addEventListener('DOMContentLoaded', function() {
      const dateInput = document.getElementById('date_called');
      if (dateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
      }
      
      // Set up today's date hidden field
      setTodaysDate();
      
      // Set up hidden textbox functionality for radio buttons and checkboxes
      setupHiddenTextboxes();
      
       // Set up deposit type mutual exclusivity
       setupDepositTypeExclusivity();
       
       // Set up payment method mutual exclusivity
       setupPaymentMethodExclusivity();
       
       // Set up contract relationship mutual exclusivity
       setupContractRelationshipExclusivity();
       
       // Set up full service address
       updateFullServiceAddress();
       
       // Set up full bill address
       updateFullBillAddress();
       
       // Set up full name
       updateFullName();

      // Wire Upload Excel button
      const uploadBtn = document.getElementById('uploadExcelBtn');
      const excelInput = document.getElementById('excelFile');
      if (uploadBtn && excelInput) {
        uploadBtn.addEventListener('click', function() { excelInput.click(); });
        excelInput.addEventListener('change', handleExcelUpload);
      }

      // Set up drag and drop functionality
      setupDragAndDrop();
      
      // Set up phone number formatting
      setupPhoneFormatting();
      
      // Set up service option exclusivity
      setupServiceOptionExclusivity();
    });

    // Keyboard shortcut for example fill (Ctrl+Shift)
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey) {
        event.preventDefault(); // Prevent browser default behavior
        fillExampleData();
        console.log('Example data filled via keyboard shortcut (Ctrl+Shift)');
      }
    });

    // Phone number formatting function
    function formatPhoneNumber(input) {
      // Remove all non-numeric characters
      let value = input.value.replace(/\D/g, '');
      
      // Format as (xxx) xxx-xxxx
      if (value.length >= 6) {
        value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
      } else if (value.length >= 3) {
        value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
      } else if (value.length > 0) {
        value = `(${value}`;
      }
      
      input.value = value;
    }

    // Phone number formatting function for Excel autofill
    function formatPhoneNumberFromExcel(phoneValue) {
      if (!phoneValue || phoneValue.trim() === '') return '';
      
      // Remove all non-numeric characters
      let value = phoneValue.replace(/\D/g, '');
      
      // If it's already formatted or empty, return as-is
      if (value.length === 0) return '';
      
      // Format as (xxx) xxx-xxxx
      if (value.length >= 10) {
        // Take last 10 digits if more than 10
        value = value.slice(-10);
        return `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
      } else if (value.length >= 6) {
        return `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
      } else if (value.length >= 3) {
        return `(${value.slice(0, 3)}) ${value.slice(3)}`;
      } else if (value.length > 0) {
        return `(${value}`;
      }
      
      return phoneValue; // Return original if can't format
    }

    // Set up phone formatting for all phone fields
    function setupPhoneFormatting() {
      const phoneFields = ['contact_phone', 'emp_phone_main', 'spouse_emp_phone'];
      
      phoneFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            formatPhoneNumber(this);
          });
        }
      });
    }

    // Set up service option exclusivity
    function setupServiceOptionExclusivity() {
      const serviceOptions = ['install_new_service', 'install_meter', 'read_and_turn_on'];
      
      serviceOptions.forEach(optionId => {
        const option = document.getElementById(optionId);
        if (option) {
          option.addEventListener('change', function() {
            if (this.checked) {
              // Create hidden textbox for the selected option
              createHiddenTextbox(this.id, 'yes', this.value.toUpperCase().replace(/_/g, ' '));
              
              // Create additional hidden field with exact PDF field name
              let pdfField = document.getElementById(this.id);
              if (!pdfField || pdfField.type !== 'hidden') {
                // Remove existing PDF field if it exists
                const existingPdfField = document.querySelector(`input[name="${this.id}"]`);
                if (existingPdfField && existingPdfField.type === 'hidden') {
                  existingPdfField.remove();
                }
                
                // Create new PDF field
                const newPdfField = document.createElement('input');
                newPdfField.type = 'hidden';
                newPdfField.name = this.id;
                newPdfField.value = 'yes';
                document.getElementById('customForm').appendChild(newPdfField);
              }
              
              // Uncheck other options and remove their hidden textboxes
              serviceOptions.forEach(otherId => {
                if (otherId !== optionId) {
                  const otherOption = document.getElementById(otherId);
                  if (otherOption) {
                    otherOption.checked = false;
                    const otherTextbox = document.getElementById(otherId + '_textbox');
                    if (otherTextbox) {
                      otherTextbox.remove();
                    }
                    // Remove PDF field for unselected option
                    const otherPdfField = document.querySelector(`input[name="${otherId}"]`);
                    if (otherPdfField && otherPdfField.type === 'hidden') {
                      otherPdfField.remove();
                    }
                  }
                }
              });
            }
          });
        }
      });
      
      // Set default selection (READ AND TURN ON)
      const defaultOption = document.getElementById('read_and_turn_on');
      if (defaultOption) {
        defaultOption.checked = true;
        createHiddenTextbox('read_and_turn_on', 'yes', 'READ AND TURN ON');
        
        // Create PDF field for default selection
        const defaultPdfField = document.createElement('input');
        defaultPdfField.type = 'hidden';
        defaultPdfField.name = 'read_and_turn_on';
        defaultPdfField.value = 'yes';
        document.getElementById('customForm').appendChild(defaultPdfField);
      }
    }

    // Hidden textbox functionality
    function setupHiddenTextboxes() {
      // Handle radio buttons
      const radioButtons = document.querySelectorAll('input[type="radio"]');
      radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.checked) {
            createHiddenTextbox(this.name, this.value, this.nextSibling.textContent.trim());
          }
        });
      });

       // Handle checkboxes (excluding payment method checkboxes which have custom handling)
       const checkboxes = document.querySelectorAll('input[type="checkbox"]:not([id^="payment_method_"])');
       checkboxes.forEach(checkbox => {
         checkbox.addEventListener('change', function() {
           if (this.checked) {
             createHiddenTextbox(this.name, this.value, this.nextSibling.textContent.trim());
           } else {
             removeHiddenTextbox(this.name + '_textbox');
           }
         });
       });
    }

    // --- Excel Upload & Autofill ---
    const EXCEL_TO_FORM_MAP = {
      // Header
      date_called: 'CreateDt',
      date_wanted: 'WantedDt',
      account_number: 'AcctNum',
      wo_number: 'WorkNum',
      cycle_number: 'Route',
      clerks_name: 'CreateBy',

      // Service Address & Type
      service_street: ['OwnStrNum','OwnStrName'],
      service_city: 'OwnCity',
      service_state: 'OwnState',
      service_zip: 'OwnZIP5', // Updated to use OwnZIP5

      // Customer
      first_name: 'FirstName',
      last_name: 'LastName',
      full_name: ['FirstName', 'LastName'], // Will be combined with space
      contact_phone: 'DayPhone',
      
      // Send Bill Address - will be auto-filled with service address values
      send_bill_street: ['OwnStrNum','OwnStrName'], // Same as service address
      send_bill_city: 'OwnCity', // Same as service address
      send_bill_state: 'OwnState', // Same as service address
      send_bill_zip: 'OwnZIP5', // Same as service address

      // Work Order & Reads (if available)
      last_read: 'Reading',
      current_read: 'Usage',

      // Misc - REMOVED comments mapping to prevent Excel from overriding form type logic
      // comments: 'Text194' // Commented out to prevent Excel override
    };

    const DATE_INPUT_IDS = new Set([
      'date_called','date_wanted','connect_date','last_bill_date','id_exp_date_main','spouse_id_exp_date'
    ]);

    function getMappedValue(row, mapEntry, fieldId){
      if (!mapEntry) return '';
      if (Array.isArray(mapEntry)){
        const parts = mapEntry.map(k => row[k] ?? '').filter(Boolean);
        return parts.join(' ').trim();
      }
      const v = row[mapEntry];
      if (v == null) return '';
      if (DATE_INPUT_IDS.has(fieldId)) return toDateInputValue(v);
      
      // Special handling for clerk's name - convert "CYNT" to "CYNTHIA"
      if (fieldId === 'clerks_name' && String(v).toUpperCase() === 'CYNT') {
        return 'CYNTHIA';
      }
      
      // Special handling for phone numbers - format as (xxx) xxx-xxxx
      if (fieldId === 'contact_phone' || fieldId === 'emp_phone_main' || fieldId === 'spouse_emp_phone') {
        return formatPhoneNumberFromExcel(String(v));
      }
      
      return String(v);
    }

    function toDateInputValue(v){
      if (v == null || v === '') return '';
      if (typeof v === 'number'){
        const d = XLSX.SSF.parse_date_code(v);
        if (d){
          const y = d.y || 1970;
          const m = String((d.m || 1)).padStart(2,'0');
          const day = String(d.d || 1).padStart(2,'0');
          return `${y}-${m}-${day}`;
        }
      }
      // Try parsing strings like mm/dd/yyyy
      const parsed = new Date(v);
      if (!isNaN(parsed)){
        const y = parsed.getFullYear();
        const m = String(parsed.getMonth()+1).padStart(2,'0');
        const day = String(parsed.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }
      return '';
    }

    function setFormMode(mode){
      console.log('üîß DEBUG: setFormMode called with mode:', mode);
      
      const badge = document.getElementById('formTypeBadge');
      const formTypeContainer = document.getElementById('formTypeContainer');
      const form = document.getElementById('customForm');
      const dragDropContainer = document.querySelector('.drag-drop-container');
      
      // Show the form and badge when setFormMode is called
      if (formTypeContainer) formTypeContainer.style.display = 'block';
      if (form) form.style.display = 'block';
      if (dragDropContainer) dragDropContainer.style.display = 'none';
      
      if (badge){
        console.log('üîß DEBUG: Badge element found, setting form type...');
        if (mode === 'disconnection'){
          console.log('üîß DEBUG: Setting DISCONNECTION mode');
          badge.textContent = 'Form Type: Disconnection';
          badge.classList.add('disconnection');
          // Auto-fill disconnect comments
          const disconnectComments = document.getElementById('disconnect_comments');
          if (disconnectComments) {
            disconnectComments.value = 'PLEASE READ AND DISCONNECT';
            console.log('üîß DEBUG: Set disconnect_comments to:', disconnectComments.value);
          }
          // Auto-fill notes with DISCONNECT
          const notes = document.getElementById('notes');
          if (notes) {
            notes.value = 'DISCONNECT';
            console.log('üîß DEBUG: Set notes to:', notes.value);
          }
          // Auto-fill comments with PLEASE READ AND DISCONNECT for disconnection
          const comments = document.getElementById('comments');
          if (comments) {
            comments.value = 'PLEASE READ AND DISCONNECT';
            console.log('üîß DEBUG: Set comments to:', comments.value);
          }
        } else {
          console.log('üîß DEBUG: Setting CONNECTION mode');
          badge.textContent = 'Form Type: Connection';
          badge.classList.remove('disconnection');
          // Auto-fill comments with VER ID for connection
          const comments = document.getElementById('comments');
          if (comments) {
            comments.value = 'VER ID';
            console.log('üîß DEBUG: Set comments to:', comments.value);
          }
          // Auto-fill notes with CONNECT
          const notes = document.getElementById('notes');
          if (notes) {
            notes.value = 'CONNECT';
            console.log('üîß DEBUG: Set notes to:', notes.value);
          }
        }
        console.log('üîß DEBUG: Badge textContent is now:', badge.textContent);
      } else {
        console.log('üîß DEBUG: Badge element NOT found!');
      }
      document.querySelectorAll('[data-for]')
        .forEach(el=>{
          const showFor = el.getAttribute('data-for');
          if (showFor === mode) el.classList.remove('hidden');
          else if (showFor) el.classList.add('hidden');
        });
        
      // Apply visual cues for disconnection forms
      updateVisualCues(mode);
    }

    // Function to update visual cues based on form type
    function updateVisualCues(mode) {
      console.log('üé® DEBUG: Updating visual cues for mode:', mode);
      
      // Fields that need visual cues for disconnection forms
      const requiredFieldsForDisconnection = [
        'send_bill_street',
        'send_bill_city', 
        'send_bill_state',
        'send_bill_zip',
        'contact_phone'
      ];
      
      requiredFieldsForDisconnection.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          if (mode === 'disconnection') {
            // Add visual cue for disconnection forms
            field.classList.add('required-field-cue');
            console.log(`üé® DEBUG: Added visual cue to ${fieldId}`);
          } else {
            // Remove visual cue for connection forms
            field.classList.remove('required-field-cue');
            console.log(`üé® DEBUG: Removed visual cue from ${fieldId}`);
          }
        }
      });
    }

    async function handleExcelUpload(e){
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try{
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
        if (!rows.length) return;
        const r = rows[0]; // use first row

        // Determine form mode from tblWorkType.Descr
        const typeDescr = r['tblWorkType.Descr'] || r['Work Type'] || '';
        console.log('üîç DEBUG: Excel form type detection:');
        console.log('  - tblWorkType.Descr:', r['tblWorkType.Descr']);
        console.log('  - Work Type:', r['Work Type']);
        console.log('  - typeDescr:', typeDescr);
        console.log('  - typeDescr.toUpperCase():', String(typeDescr).toUpperCase());
        console.log('  - includes DISC:', String(typeDescr).toUpperCase().includes('DISC'));
        
        const mode = (String(typeDescr).toUpperCase().includes('DISC')) ? 'disconnection' : 'connection';
        console.log('  - Final mode determined:', mode);
        
        setFormMode(mode);

        Object.entries(EXCEL_TO_FORM_MAP).forEach(([fieldId, mapEntry])=>{
          const el = document.getElementById(fieldId);
          if (!el) return;
          
          // Skip send bill address fields for disconnection forms
          const sendBillFields = ['send_bill_street', 'send_bill_city', 'send_bill_state', 'send_bill_zip'];
          if (mode === 'disconnection' && sendBillFields.includes(fieldId)) {
            console.log(`üîß DEBUG: Skipping ${fieldId} for disconnection form`);
            return;
          }
          
          const val = getMappedValue(r, mapEntry, fieldId);
          if (val !== undefined){ 
            el.value = val;
            console.log(`üîß DEBUG: Set ${fieldId} to:`, val);
          }
        });

        // Keep derived hidden address updated
        updateFullServiceAddress();
        
        // Keep derived full name updated
        updateFullName();

        console.log('üîß DEBUG: Excel autofill complete.');
        console.log('üîß DEBUG: Final comments value after autofill:', document.getElementById('comments').value);
        console.log('üîß DEBUG: Final badge text after autofill:', document.getElementById('formTypeBadge').textContent);
      }catch(err){
        console.error('Failed to read Excel:', err);
      }finally{
        // reset so the same file can be chosen again
        e.target.value = '';
      }
    }

    function createHiddenTextbox(name, value, text) {
      const textboxId = name + '_textbox';
      
      // Remove existing textbox if it exists
      removeHiddenTextbox(textboxId);
      
      // Create new hidden textbox
      const textbox = document.createElement('input');
      textbox.type = 'hidden';
      textbox.id = textboxId;
      textbox.name = textboxId;
      textbox.value = text; // Use the display text, not the value
      
      // Add to form
      document.getElementById('customForm').appendChild(textbox);
      
      console.log(`Created hidden textbox: ${textboxId} with value: "${text}"`);
    }

    function removeHiddenTextbox(textboxId) {
      const existingTextbox = document.getElementById(textboxId);
      if (existingTextbox) {
        existingTextbox.remove();
        console.log(`Removed hidden textbox: ${textboxId}`);
      }
    }

     // Deposit type mutual exclusivity
     function setupDepositTypeExclusivity() {
       const depositTypeCheckboxes = [
         document.getElementById('deposit_type_establish'),
         document.getElementById('deposit_type_initial')
       ];

       depositTypeCheckboxes.forEach(checkbox => {
         if (checkbox) {
           checkbox.addEventListener('change', function() {
             if (this.checked) {
               // Uncheck the other deposit type checkbox
               depositTypeCheckboxes.forEach(otherCheckbox => {
                 if (otherCheckbox !== this && otherCheckbox.checked) {
                   otherCheckbox.checked = false;
                   // Remove the hidden textbox for the unchecked option
                   removeHiddenTextbox(otherCheckbox.name + '_textbox');
                 }
               });
             }
           });
         }
       });
     }

     // Payment method mutual exclusivity
     function setupPaymentMethodExclusivity() {
       const paymentMethodCheckboxes = [
         document.getElementById('payment_method_cash'),
         document.getElementById('payment_method_check')
       ];

       paymentMethodCheckboxes.forEach(checkbox => {
         if (checkbox) {
           checkbox.addEventListener('change', function() {
             if (this.checked) {
               // Uncheck the other payment method checkbox
               paymentMethodCheckboxes.forEach(otherCheckbox => {
                 if (otherCheckbox !== this && otherCheckbox.checked) {
                   otherCheckbox.checked = false;
                 }
               });
               
               // Create single payment_method_textbox with the selected value
               const textboxId = 'payment_method_textbox';
               const displayText = this.nextSibling.textContent.trim().toUpperCase();
               createHiddenTextbox('payment_method', this.value, displayText);
             } else {
               // If this checkbox is unchecked, remove the payment method textbox
               removeHiddenTextbox('payment_method_textbox');
             }
           });
         }
       });
     }

     // Contract relationship mutual exclusivity
     function setupContractRelationshipExclusivity() {
       const contractRelationshipCheckboxes = [
         document.getElementById('owner'),
         document.getElementById('tenant'),
         document.getElementById('real_estate_agent'),
         document.getElementById('property_manager')
       ];

       contractRelationshipCheckboxes.forEach(checkbox => {
         if (checkbox) {
           checkbox.addEventListener('change', function() {
             if (this.checked) {
               // Uncheck all other contract relationship checkboxes
               contractRelationshipCheckboxes.forEach(otherCheckbox => {
                 if (otherCheckbox !== this && otherCheckbox.checked) {
                   otherCheckbox.checked = false;
                   // Remove hidden textbox for unchecked option
                   removeHiddenTextbox(otherCheckbox.name + '_textbox');
                 }
               });
               
               // Create hidden textbox for the selected relationship
               const displayText = this.nextSibling.textContent.trim().toUpperCase();
               createHiddenTextbox(this.name, this.value, displayText);
             } else {
               // If this checkbox is unchecked, remove its hidden textbox
               removeHiddenTextbox(this.name + '_textbox');
             }
           });
         }
       });
     }

     // Update full service address function
     function updateFullServiceAddress() {
       const street = document.getElementById('service_street').value || '';
       const unit = document.getElementById('service_unit').value || '';
       const city = document.getElementById('service_city').value || '';
       const state = document.getElementById('service_state').value || '';
       const zip = document.getElementById('service_zip').value || '';
       
       // Create service_street_unit hidden textbox (street + unit)
       const streetUnit = unit.trim() ? `${street} ${unit}`.trim() : street;
       let streetUnitField = document.getElementById('service_street_unit');
       if (!streetUnitField) {
         streetUnitField = document.createElement('input');
         streetUnitField.type = 'hidden';
         streetUnitField.id = 'service_street_unit';
         streetUnitField.name = 'service_street_unit';
         document.getElementById('customForm').appendChild(streetUnitField);
       }
       streetUnitField.value = streetUnit;
       
       // Combine the address parts, including unit if present
       const addressParts = [street];
       if (unit.trim()) {
         addressParts.push(unit);
       }
       addressParts.push(city, state, zip);
       const fullAddress = addressParts.filter(part => part.trim()).join(', ');
       
       // Create or update the hidden textbox
       let hiddenField = document.getElementById('full_service_address');
       if (!hiddenField) {
         hiddenField = document.createElement('input');
         hiddenField.type = 'hidden';
         hiddenField.id = 'full_service_address';
         hiddenField.name = 'full_service_address';
         document.getElementById('customForm').appendChild(hiddenField);
       }
       
       hiddenField.value = fullAddress;
       console.log(`Updated full service address: "${fullAddress}"`);
       console.log(`Updated service street unit: "${streetUnit}"`);
     }

     // Update full bill address function
     function updateFullBillAddress() {
       const street = document.getElementById('send_bill_street').value || '';
       const city = document.getElementById('send_bill_city').value || '';
       const state = document.getElementById('send_bill_state').value || '';
       const zip = document.getElementById('send_bill_zip').value || '';
       
       // Create send_bill_city_state_zip hidden textbox (city + state + zip)
       const cityStateZip = [city, state, zip].filter(part => part.trim()).join(', ');
       let cityStateZipField = document.getElementById('send_bill_city_state_zip');
       if (!cityStateZipField) {
         cityStateZipField = document.createElement('input');
         cityStateZipField.type = 'hidden';
         cityStateZipField.id = 'send_bill_city_state_zip';
         cityStateZipField.name = 'send_bill_city_state_zip';
         document.getElementById('customForm').appendChild(cityStateZipField);
       }
       cityStateZipField.value = cityStateZip;
       
       // Combine the address parts
       const fullAddress = [street, city, state, zip].filter(part => part.trim()).join(', ');
       
       // Create or update the hidden textbox
       let hiddenField = document.getElementById('full_bill_address');
       if (!hiddenField) {
         hiddenField = document.createElement('input');
         hiddenField.type = 'hidden';
         hiddenField.id = 'full_bill_address';
         hiddenField.name = 'full_bill_address';
         document.getElementById('customForm').appendChild(hiddenField);
       }
       
       hiddenField.value = fullAddress;
       console.log(`Updated full bill address: "${fullAddress}"`);
       console.log(`Updated send bill city state zip: "${cityStateZip}"`);
     }

     // Set today's date function
     function setTodaysDate() {
       const today = new Date();
       const dateString = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
       
       // Create or update the hidden textbox
       let hiddenField = document.getElementById('todays_date');
       if (!hiddenField) {
         hiddenField = document.createElement('input');
         hiddenField.type = 'hidden';
         hiddenField.id = 'todays_date';
         hiddenField.name = 'todays_date';
         document.getElementById('customForm').appendChild(hiddenField);
       }
       
       hiddenField.value = dateString;
       console.log(`Set today's date: "${dateString}"`);
     }

     // Update full name function
     function updateFullName() {
       const firstName = document.getElementById('first_name').value || '';
       const lastName = document.getElementById('last_name').value || '';
       
       // Combine first and last name with a space
       const fullName = [firstName, lastName].filter(part => part.trim()).join(' ');
       
       // Create or update the hidden textbox
       let hiddenField = document.getElementById('full_name');
       if (!hiddenField) {
         hiddenField = document.createElement('input');
         hiddenField.type = 'hidden';
         hiddenField.id = 'full_name';
         hiddenField.name = 'full_name';
         document.getElementById('customForm').appendChild(hiddenField);
       }
       
       hiddenField.value = fullName;
       console.log(`Updated full name: "${fullName}"`);
     }

    // Drag and Drop functionality
    function setupDragAndDrop() {
      const dragDropArea = document.getElementById('dragDropArea');
      const excelInput = document.getElementById('excelFile');

      if (!dragDropArea || !excelInput) return;

      // Click to browse
      dragDropArea.addEventListener('click', function() {
        excelInput.click();
      });

      // Prevent default drag behaviors
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      // Highlight drop area when item is dragged over it
      ['dragenter', 'dragover'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, unhighlight, false);
      });

      // Handle dropped files
      dragDropArea.addEventListener('drop', handleDrop, false);

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      function highlight(e) {
        dragDropArea.classList.add('drag-over');
      }

      function unhighlight(e) {
        dragDropArea.classList.remove('drag-over');
      }

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
          const file = files[0];
          // Check if it's an Excel file
          if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || 
              file.type === 'application/vnd.ms-excel' ||
              file.name.toLowerCase().endsWith('.xlsx') ||
              file.name.toLowerCase().endsWith('.xls')) {
            
            // Create a fake event object to match the expected format
            const fakeEvent = {
              target: {
                files: [file]
              }
            };
            
            handleExcelUpload(fakeEvent);
          } else {
            alert('Please drop an Excel file (.xlsx or .xls)');
          }
        }
      }
    }

    // Example fill function
    function fillExampleData() {
      // Show the form and preserve current mode (or default to connection if not set)
      const badge = document.getElementById('formTypeBadge');
      const currentMode = badge && badge.textContent.includes('Disconnection') ? 'disconnection' : 'connection';
      setFormMode(currentMode);
      
      // Hide the drag-drop area when form is shown
      document.querySelector('.drag-drop-container').style.display = 'none';
      
      // Header fields
      document.getElementById('date_wanted').value = '2024-01-20';
      document.getElementById('account_number').value = '123456789';
      document.getElementById('wo_number').value = 'WO-2024-001';
       document.getElementById('cycle_number').value = '3';
       document.getElementById('clerks_name').value = 'Cynthia';

      // Contract Relationship
      document.getElementById('owner').checked = true;

       // Service Address & Type
       document.getElementById('service_street').value = '123 Main Street';
       document.getElementById('service_unit').value = 'Apt 2B';
       document.getElementById('service_city').value = 'SALINAS';
       document.getElementById('service_state').value = 'CA';
       document.getElementById('service_zip').value = '93901';
       
       // Update full service address after filling the fields
       updateFullServiceAddress();

      // Customer
      document.getElementById('first_name').value = 'John';
      document.getElementById('middle_ex').value = 'A';
      document.getElementById('last_name').value = 'Smith';
      
      // Update full name after setting first and last names
      updateFullName();
      document.getElementById('connect_date').value = '2024-01-15';
       document.getElementById('contact_phone').value = '(555) 123-4567';
       document.getElementById('send_bill_street').value = '123 Main Street';
       document.getElementById('send_bill_city').value = 'Salinas';
       document.getElementById('send_bill_state').value = 'CA';
       document.getElementById('send_bill_zip').value = '93901';

       // Employment & Identification - Main Applicant
       document.getElementById('employer_main').value = 'ABC Company';
       document.getElementById('emp_phone_main').value = '(555) 234-5678';
      document.getElementById('ssn_main').value = '6789';
      document.getElementById('id_no_main').value = 'DL123456789';
      document.getElementById('id_state_type').value = 'CA/Driver License';
      document.getElementById('id_exp_date_main').value = '2029-01-15';

      // Employment & Identification - Spouse
      document.getElementById('spouse_name').value = 'Jane Smith';
      document.getElementById('spouse_employer').value = 'XYZ Corporation';
      document.getElementById('spouse_emp_phone').value = '(555) 345-6789';
      document.getElementById('spouse_ssn').value = '987-65-4321';
      document.getElementById('spouse_id_no').value = 'DL987654321';
      document.getElementById('spouse_id_exp_date').value = '2028-06-20';

      // Previous Address
      document.getElementById('previous_address').value = '456 Oak Avenue, Previous City, CA 90211';

      // Deposit & Payment
      document.getElementById('deposit_amount').value = '150.00';
      document.getElementById('payment_method_cash').checked = true;
       document.getElementById('check_number').value = '1234';
      document.getElementById('deposit_type_initial').checked = true;

       // Work Order & Reads (only one can be selected)
       document.getElementById('read_and_turn_on').checked = true;
       document.getElementById('notes').value = 'CONNECT';
       document.getElementById('remarks').value = 'All systems operational';
       
       // Set comments based on current form type
       const formTypeBadge = document.getElementById('formTypeBadge');
       const isDisconnection = formTypeBadge && formTypeBadge.textContent.includes('Disconnection');
       document.getElementById('comments').value = isDisconnection ? 'PLEASE READ AND DISCONNECT' : 'VER ID';

      // Disconnection-specific fields (with safety checks)
      // These fields will be filled even if hidden, so they're ready when user switches to disconnection mode
      const shutOffNonPayment = document.getElementById('shut_off_non_payment');
      if (shutOffNonPayment) {
        shutOffNonPayment.checked = true;
        console.log('Filled shut_off_non_payment');
      }
      
      const readAndShutOff = document.getElementById('read_and_shut_off');
      if (readAndShutOff) {
        readAndShutOff.checked = true;
        console.log('Filled read_and_shut_off');
      }
      
      const newAccountDeposit = document.getElementById('new_account_deposit');
      if (newAccountDeposit) {
        newAccountDeposit.value = '50.00';
        console.log('Filled new_account_deposit');
      }
      
      const depositRequiredYes = document.getElementById('deposit_required_yes');
      if (depositRequiredYes) {
        depositRequiredYes.checked = true;
        console.log('Filled deposit_required_yes');
      }
      
      const disconnectDepositAmount = document.getElementById('disconnect_deposit_amount');
      if (disconnectDepositAmount) {
        disconnectDepositAmount.value = '75.00';
        console.log('Filled disconnect_deposit_amount');
      }
      
      const paymentDue = document.getElementById('payment_due');
      if (paymentDue) {
        paymentDue.value = '125.50';
        console.log('Filled payment_due');
      }
      
      const disconnectComments = document.getElementById('disconnect_comments');
      if (disconnectComments) {
        disconnectComments.value = 'VER ID';
        console.log('Filled disconnect_comments');
      }

      // Trigger hidden textbox creation for selected options
      const selectedRadios = document.querySelectorAll('input[type="radio"]:checked');
      selectedRadios.forEach(radio => {
        const event = new Event('change');
        radio.dispatchEvent(event);
      });

      const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      selectedCheckboxes.forEach(checkbox => {
        const event = new Event('change');
        checkbox.dispatchEvent(event);
      });

      console.log('Form filled with example data');
    }

    // Form submission handler - automatically download PDFs
    function handleSubmit(event) {
      event.preventDefault();
      
      // Hide the form and drag-drop area, show processing message
      document.getElementById('customForm').style.display = 'none';
      document.querySelector('.drag-drop-container').style.display = 'none';
      document.getElementById('thankYouMessage').style.display = 'block';
      
      // Automatically start downloading PDFs
      downloadPDF();
      
      return false;
    }

    // Function to convert date from yyyy-mm-dd to mm/dd/yyyy format
    function formatDateToMMDDYYYY(dateString) {
      if (!dateString) return '';
      
      // Parse the date string (yyyy-mm-dd format)
      const date = new Date(dateString + 'T00:00:00'); // Add time to avoid timezone issues
      
      // Check if date is valid
      if (isNaN(date.getTime())) return dateString;
      
      // Format as mm/dd/yyyy
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = date.getFullYear();
      
      return `${month}/${day}/${year}`;
    }

    // Global variables to store PDF data
    let pdf1Data = null;
    let pdf2Data = null;
    let pdf1Name = '';
    let pdf2Name = '';

    // PDF download function - generates PDFs and shows previews
    async function downloadPDF() {
      const downloadBtn = document.getElementById('downloadBtn');
      const originalText = downloadBtn.textContent;
      try{
        downloadBtn.textContent='Processing...';
        downloadBtn.disabled=true;

        // Update all hidden fields with latest values before submission
        updateFullBillAddress();
        updateFullServiceAddress();
        updateFullName();

        // Create FormData and convert all text values to uppercase
        const form = document.getElementById('customForm');
        const formData = new FormData();
        
        // Get all form elements and convert text values to uppercase
        const formElements = form.querySelectorAll('input, select, textarea');
        formElements.forEach(element => {
          if (element.type === 'file') {
            // Keep file inputs as-is
            if (element.files && element.files.length > 0) {
              formData.append(element.name, element.files[0]);
            }
          } else if (element.type === 'checkbox' || element.type === 'radio') {
            // Keep checkbox/radio values as-is
            if (element.checked) {
              formData.append(element.name, element.value);
            }
          } else {
            // Convert all other text values to uppercase
            const value = element.value ? element.value.toUpperCase() : '';
            if (element.name && value !== '') {
              formData.append(element.name, value);
            }
          }
        });
        
        // Determine form type from the badge
        const badge = document.getElementById('formTypeBadge');
        const isDisconnection = badge && badge.textContent.includes('Disconnection');
        
        // Set PDF names based on form type
        pdf1Name = isDisconnection ? 'disconnect_order' : 'deposit_reciept';
        pdf2Name = isDisconnection ? 'disconnect_record' : 'connect_order';
        
        // Update PDF titles
        document.getElementById('pdf1Title').textContent = pdf1Name.replace('_', ' ').toUpperCase();
        document.getElementById('pdf2Title').textContent = pdf2Name.replace('_', ' ').toUpperCase();
        
        // Debug: Log all form data being sent
        console.log('Form data being sent to PDF:');
        console.log(`Form type: ${isDisconnection ? 'Disconnection' : 'Connection'}`);
        console.log(`Generating PDFs: ${pdf1Name}.pdf and ${pdf2Name}.pdf`);
        for (let [key, value] of formData.entries()) {
          console.log(`${key}: ${value}`);
        }
        
        // Ensure all checkboxes and radios are properly included
        const allInputs = document.querySelectorAll('input, textarea, select');
        allInputs.forEach(input => {
          if (input.type === 'checkbox' || input.type === 'radio') {
            if (input.checked) {
              // For radio buttons, use the specific field name that matches the PDF
              if (input.type === 'radio' && input.name === 'deposit_required') {
                const fieldName = input.value === 'yes' ? 'deposit_required_yes' : 'deposit_required_no';
                formData.set(fieldName, input.value);
                console.log(`Added checked radio: ${fieldName} = ${input.value}`);
              } else {
                formData.set(input.name, input.value);
                console.log(`Added checked ${input.type}: ${input.name} = ${input.value}`);
              }
            }
          } else if (input.type === 'hidden') {
            formData.set(input.name, input.value);
            console.log(`Added hidden field: ${input.name} = ${input.value}`);
          } else if (input.name === 'deposit_amount') {
            // Add dollar sign prefix to deposit amount
            const depositValue = input.value ? `$${input.value}` : input.value;
            formData.set(input.name, depositValue);
            console.log(`Added deposit amount with $ prefix: ${input.name} = ${depositValue}`);
          } else if (input.name === 'disconnect_deposit_amount') {
            // Add dollar sign prefix to disconnect deposit amount
            const disconnectDepositValue = input.value ? `$${input.value}` : input.value;
            formData.set(input.name, disconnectDepositValue);
            console.log(`Added disconnect deposit amount with $ prefix: ${input.name} = ${disconnectDepositValue}`);
          } else if (input.type === 'date' && input.value) {
            // Convert date from yyyy-mm-dd to mm/dd/yyyy format
            const formattedDate = formatDateToMMDDYYYY(input.value);
            formData.set(input.name, formattedDate);
            console.log(`Added formatted date: ${input.name} = ${formattedDate}`);
          }
        });
        
        // Generate first PDF
        downloadBtn.textContent=`Generating ${pdf1Name}.pdf...`;
        const response1 = await fetch(`/edit_pdf?pdf=${pdf1Name}`, { method:'POST', body:formData });
        if(!response1.ok) throw new Error('Server error: '+response1.status);

        pdf1Data = await response1.blob();
        const url1 = URL.createObjectURL(pdf1Data);
        document.getElementById('pdf1Preview').src = url1;

        // Generate second PDF
        downloadBtn.textContent=`Generating ${pdf2Name}.pdf...`;
        const response2 = await fetch(`/edit_pdf?pdf=${pdf2Name}`, { method:'POST', body:formData });
        if(!response2.ok) throw new Error('Server error: '+response2.status);

        pdf2Data = await response2.blob();
        const url2 = URL.createObjectURL(pdf2Data);
        document.getElementById('pdf2Preview').src = url2;

        downloadBtn.textContent='PDFs Generated!';
        setTimeout(()=>{ downloadBtn.textContent=originalText; downloadBtn.disabled=false; }, 2000);

        // Auto-download both PDFs
        setTimeout(() => {
          downloadAllPDFs();
        }, 1000);
      }catch(err){
        console.error('Error generating PDF:', err);
        downloadBtn.textContent='Error - Try Again';
        downloadBtn.disabled=false;
        setTimeout(()=>{ downloadBtn.textContent=originalText; }, 2000);
      }
    }

    // Function to download individual PDFs
    function downloadPDF1() {
      if (pdf1Data) {
        const url = URL.createObjectURL(pdf1Data);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${pdf1Name}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    }

    function downloadPDF2() {
      if (pdf2Data) {
        const url = URL.createObjectURL(pdf2Data);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${pdf2Name}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    }

    // Function to download all PDFs
    function downloadAllPDFs() {
      downloadPDF1();
      downloadPDF2();
    }

    // Global variables to store Word document data
    let word1Data = null;
    let word2Data = null;

    // Function to convert PDF to Word document
    async function convertPDFToWord(pdfBlob, filename) {
      try {
        // Load PDF using PDF.js
        const arrayBuffer = await pdfBlob.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        
        const { Document, Packer, Paragraph, ImageRun } = docx;
        
        // Render each page to image
        const pages = [];
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const vp1 = page.getViewport({ scale: 1 });
          const inchW = vp1.width / 72;
          const inchH = vp1.height / 72;
          const scale = 300 / 72; // 300 DPI
          const vp = page.getViewport({ scale });
          
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(vp.width);
          canvas.height = Math.round(vp.height);
          const ctx = canvas.getContext('2d');
          
          // White background
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          await page.render({ canvasContext: ctx, viewport: vp, intent: 'print' }).promise;
          
          const url = canvas.toDataURL('image/png');
          const bin = await (await fetch(url)).arrayBuffer();
          pages.push({ bin, inchW, inchH });
        }
        
        // Create Word document with page-sized images
        const sections = pages.map(({bin, inchW, inchH}) => {
          const pxW = Math.round(inchW * 96);
          const pxH = Math.round(inchH * 96);
          return {
            properties: {
              page: { 
                size: { 
                  width: Math.round(inchW * 72 * 20), 
                  height: Math.round(inchH * 72 * 20) 
                }, 
                margin: { top: 0, right: 0, bottom: 0, left: 0 } 
              }
            },
            children: [ 
              new Paragraph({ 
                children: [ 
                  new ImageRun({ 
                    data: bin, 
                    transformation: { width: pxW, height: pxH } 
                  }) 
                ] 
              }) 
            ]
          };
        });
        
        const doc = new Document({ sections });
        const blob = await Packer.toBlob(doc);
        
        return blob;
      } catch (error) {
        console.error('Error converting PDF to Word:', error);
        throw error;
      }
    }

    // Function to download individual Word documents
    async function downloadWord1() {
      if (!pdf1Data) {
        alert('PDF 1 not available for conversion');
        return;
      }
      
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Converting...';
      button.disabled = true;
      
      try {
        if (!word1Data) {
          word1Data = await convertPDFToWord(pdf1Data, pdf1Name);
        }
        
        const url = URL.createObjectURL(word1Data);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${pdf1Name}_converted.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Error downloading Word document 1:', error);
        alert('Error converting PDF to Word document');
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    }

    async function downloadWord2() {
      if (!pdf2Data) {
        alert('PDF 2 not available for conversion');
        return;
      }
      
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Converting...';
      button.disabled = true;
      
      try {
        if (!word2Data) {
          word2Data = await convertPDFToWord(pdf2Data, pdf2Name);
        }
        
        const url = URL.createObjectURL(word2Data);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${pdf2Name}_converted.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Error downloading Word document 2:', error);
        alert('Error converting PDF to Word document');
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    }

    // Function to download all Word documents
    async function downloadAllWordDocs() {
      const button = document.getElementById('downloadAllWordBtn');
      const originalText = button.textContent;
      button.textContent = 'Converting...';
      button.disabled = true;
      
      try {
        // Convert both PDFs to Word if not already converted
        if (pdf1Data && !word1Data) {
          word1Data = await convertPDFToWord(pdf1Data, pdf1Name);
        }
        if (pdf2Data && !word2Data) {
          word2Data = await convertPDFToWord(pdf2Data, pdf2Name);
        }
        
        // Download both Word documents
        if (word1Data) {
          const url1 = URL.createObjectURL(word1Data);
          const a1 = document.createElement('a');
          a1.href = url1;
          a1.download = `${pdf1Name}_converted.docx`;
          document.body.appendChild(a1);
          a1.click();
          document.body.removeChild(a1);
          URL.revokeObjectURL(url1);
        }
        
        if (word2Data) {
          const url2 = URL.createObjectURL(word2Data);
          const a2 = document.createElement('a');
          a2.href = url2;
          a2.download = `${pdf2Name}_converted.docx`;
          document.body.appendChild(a2);
          a2.click();
          document.body.removeChild(a2);
          URL.revokeObjectURL(url2);
        }
        
        button.textContent = 'Downloaded!';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Error downloading Word documents:', error);
        alert('Error converting PDFs to Word documents');
        button.textContent = originalText;
        button.disabled = false;
      }
    }

    // Function to go back to the form
    function goBackToForm() {
      document.getElementById('thankYouMessage').style.display = 'none';
      document.getElementById('customForm').style.display = 'block';
      document.querySelector('.drag-drop-container').style.display = 'block';
      
      // Clear PDF and Word data
      pdf1Data = null;
      pdf2Data = null;
      word1Data = null;
      word2Data = null;
      document.getElementById('pdf1Preview').src = '';
      document.getElementById('pdf2Preview').src = '';
    }

    // Field Menu Functionality
    let ctrlPressed = false;
    let shiftPressed = false;

    // Track key states
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Control') {
        ctrlPressed = true;
      }
      if (event.key === 'Shift') {
        shiftPressed = true;
      }
      
      // Check for Ctrl+Shift combination
      if (ctrlPressed && shiftPressed) {
        event.preventDefault();
        showFieldMenu();
      }
    });

    document.addEventListener('keyup', function(event) {
      if (event.key === 'Control') {
        ctrlPressed = false;
      }
      if (event.key === 'Shift') {
        shiftPressed = false;
      }
    });

    function showFieldMenu() {
      const overlay = document.getElementById('fieldMenuOverlay');
      const menu = document.getElementById('fieldMenu');
      const fieldList = document.getElementById('fieldList');
      const searchInput = document.getElementById('fieldSearch');
      
      // Clear existing content
      fieldList.innerHTML = '';
      
      // Get all input fields with IDs that are currently visible
      const allInputs = document.querySelectorAll('input[id], textarea[id], select[id]');
      const visibleInputs = Array.from(allInputs).filter(input => {
        // Check if the input or its parent container is visible
        const element = input;
        const parentSection = element.closest('[data-for]');
        
        // If the element has no data-for parent, it's always visible
        if (!parentSection) {
          return !element.closest('.hidden');
        }
        
        // If the element has a data-for parent, check if that section is visible
        return !parentSection.classList.contains('hidden');
      });
      
      if (visibleInputs.length === 0) {
        fieldList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No visible input fields found</div>';
      } else {
        // Store all field items for filtering
        window.allFieldItems = [];
        
        visibleInputs.forEach(input => {
          const fieldItem = document.createElement('div');
          fieldItem.className = 'field-item';
          
          // Get field label
          const label = document.querySelector(`label[for="${input.id}"]`);
          const labelText = label ? label.textContent.trim() : 'No label';
          
          // Get field type
          const fieldType = input.type || input.tagName.toLowerCase();
          
          fieldItem.innerHTML = `
            <div>
              <span class="field-id">
                ${input.id}
                <span class="copy-tooltip">Click to copy</span>
              </span>
              <span class="field-label">${labelText}</span>
            </div>
            <span class="field-type">${fieldType}</span>
          `;
          
          // Wire the copy handler for the entire field item
          fieldItem.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();           // stop any parent click handlers
            copyFieldId(input.id, e);
          });
          
          // Store field data for search
          fieldItem.fieldData = {
            id: input.id,
            label: labelText,
            type: fieldType
          };
          
          fieldList.appendChild(fieldItem);
          window.allFieldItems.push(fieldItem);
        });
      }
      
      // Set up search functionality
      searchInput.value = '';
      searchInput.addEventListener('input', filterFields);
      
      // Show menu
      overlay.classList.add('show');
      menu.classList.add('show');
      
      // Focus search input
      setTimeout(() => searchInput.focus(), 100);
      
      // Close on overlay click
      overlay.addEventListener('click', closeFieldMenu);
      
      // Close on Escape key
      document.addEventListener('keydown', function escapeHandler(event) {
        if (event.key === 'Escape') {
          closeFieldMenu();
          document.removeEventListener('keydown', escapeHandler);
        }
      });
    }

    function filterFields() {
      const searchTerm = document.getElementById('fieldSearch').value.toLowerCase();
      const fieldList = document.getElementById('fieldList');
      
      if (!window.allFieldItems) return;
      
      // Clear the list
      fieldList.innerHTML = '';
      
      // Filter and show matching items
      const filteredItems = window.allFieldItems.filter(item => {
        const fieldData = item.fieldData;
        return fieldData.id.toLowerCase().includes(searchTerm) ||
               fieldData.label.toLowerCase().includes(searchTerm) ||
               fieldData.type.toLowerCase().includes(searchTerm);
      });
      
      if (filteredItems.length === 0) {
        fieldList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No fields match your search</div>';
      } else {
        filteredItems.forEach(item => {
          fieldList.appendChild(item);
        });
      }
    }

    function closeFieldMenu() {
      const overlay = document.getElementById('fieldMenuOverlay');
      const menu = document.getElementById('fieldMenu');
      
      overlay.classList.remove('show');
      menu.classList.remove('show');
      
      // Remove event listener
      overlay.removeEventListener('click', closeFieldMenu);
    }

    function copyFieldId(fieldId, e) {
      // guard & stop bubbling just in case
      if (e) { e.preventDefault(); e.stopPropagation(); }

      const fieldItem = e.currentTarget; // Now the field item itself is the target
      const idElement = fieldItem.querySelector('.field-id'); // Find the ID element within
      
      // Remove copied class from all other field items first
      const allFieldItems = document.querySelectorAll('.field-item.copied');
      allFieldItems.forEach(item => {
        if (item !== fieldItem) {
          item.classList.remove('copied');
        }
      });
      
      const doTooltip = (el, text) => {
        if (!el) return; // Guard against null element
        const tip = el.querySelector('.copy-tooltip');
        if (!tip) return;
        const original = tip.textContent;
        tip.textContent = text;
        tip.classList.add('show');
        setTimeout(() => {
          tip.classList.remove('show');
          setTimeout(() => { tip.textContent = original; }, 200);
        }, 1500);
      };

      const showCopiedFeedback = () => {
        // Add the copied class for visual feedback
        if (fieldItem) {
          fieldItem.classList.add('copied');
        }
        doTooltip(idElement, 'Copied!');
        
        // Remove the copied class after animation completes
        setTimeout(() => {
          if (fieldItem) {
            fieldItem.classList.remove('copied');
          }
        }, 2000);
      };

      // attempt modern clipboard first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(fieldId)
          .then(() => showCopiedFeedback())
          .catch(() => fallback());
      } else {
        fallback();
      }

      function fallback() {
        const ta = document.createElement('textarea');
        ta.value = fieldId;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch (_) {}
        document.body.removeChild(ta);
        showCopiedFeedback();
      }
    }
  </script>
</body>
</html>
